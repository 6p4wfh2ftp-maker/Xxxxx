<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fațadă — randare AI</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#11131a; --ink:#e9eef7; --muted:#aab4c3; --line:#222738;
      --btn:#1f2937; --accent:#3b82f6; --danger:#7f1d1d;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--ink)}
    .bar{position:sticky;top:0;z-index:5;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 14px;background:#0f1118;border-bottom:1px solid var(--line)}
    .title{font-weight:800}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px;display:grid;grid-template-columns:380px 1fr;gap:14px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:13px}
    input[type=file], textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0f1118;color:var(--ink)}
    textarea{min-height:110px;resize:vertical}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid var(--line);background:var(--btn);
      color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent}
    .btn.danger{background:var(--danger);border-color:transparent}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .status{margin-top:10px;color:var(--muted);font-size:13px;white-space:pre-wrap}
    .resultBox{min-height:360px;display:flex;align-items:center;justify-content:center}
    .resultBox img{max-width:100%;height:auto;border-radius:12px;border:1px solid var(--line)}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.35}
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="bar">
    <div class="title">Fațadă — editor simplu (AI)</div>
    <div class="row">
      <button class="btn" id="btnSave" type="button">Salvează / Share</button>
      <button class="btn danger" id="btnReset" type="button">Șterge tot</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h3 style="margin:0 0 10px">1. Încarcă poza casei</h3>
      <input id="file" type="file" accept="image/*" />

      <h3 style="margin:16px 0 10px">2. Descriere (prompt)</h3>
      <textarea id="prompt">Fațadă clasică cu coloane, ancadramente și cornișă. Păstrează structura casei neschimbată.</textarea>

      <div class="row">
        <button class="btn primary" id="btnRun" type="button">Randare AI</button>
      </div>

      <div class="status" id="status">Gata.</div>

      <div class="hint">
        Dacă primești eroare, îți arăt mesajul complet (status + text).<br/>
        Notă: randarea AI necesită cheie OpenAI în Worker (secret).
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Rezultat</h3>
      <div class="resultBox" id="box">
        <div style="color:var(--muted)">Încarcă o poză ca să începi.</div>
      </div>
    </div>
  </div>

<script>
  // IMPORTANT: pune aici URL-ul worker-ului tău (cu https)
  const WORKER_URL = "https://fatada-render.6p4wfh2ftp.workers.dev/"; // schimbă dacă e altul

  const fileInput = document.getElementById("file");
  const promptEl  = document.getElementById("prompt");
  const btnRun    = document.getElementById("btnRun");
  const btnReset  = document.getElementById("btnReset");
  const btnSave   = document.getElementById("btnSave");
  const statusEl  = document.getElementById("status");
  const box       = document.getElementById("box");

  let outImg = null;

  function setResultImg(src){
    box.innerHTML = "";
    outImg = document.createElement("img");
    outImg.src = src;
    box.appendChild(outImg);
  }

  btnReset.addEventListener("click", () => {
    fileInput.value = "";
    promptEl.value = "Fațadă clasică cu coloane, ancadramente și cornișă. Păstrează structura casei neschimbată.";
    statusEl.textContent = "Reset.";
    box.innerHTML = '<div style="color:var(--muted)">Încarcă o poză ca să începi.</div>';
    outImg = null;
  });

  btnSave.addEventListener("click", async () => {
    if(!outImg) { alert("Nu ai încă o randare."); return; }
    try{
      const a = document.createElement("a");
      a.href = outImg.src;
      a.download = "randare.png";
      a.click();
      statusEl.textContent = "Am pornit descărcarea (sau long-press pe imagine → Save).";
    }catch(e){
      alert("Pe iOS: ține apăsat pe imagine → Save Image / Share.");
    }
  });

  btnRun.addEventListener("click", async () => {
    if(!fileInput.files || !fileInput.files[0]) {
      alert("Încarcă o poză!");
      return;
    }

    const prompt = (promptEl.value || "").trim();
    if(!prompt){
      alert("Scrie un prompt!");
      return;
    }

    statusEl.textContent = "Se generează...";
    box.innerHTML = '<div style="color:var(--muted)">Se generează...</div>';

    const fd = new FormData();
    // IMPORTANT: punem nume fișier (ajută pe iOS)
    fd.append("image", fileInput.files[0], "input.jpg");
    fd.append("prompt", prompt);

    let r;
    try{
      r = await fetch(WORKER_URL, { method:"POST", body: fd });
    }catch(e){
      statusEl.textContent = "Eroare conexiune: " + (e?.message || e);
      box.innerHTML = '<div style="color:var(--muted)">Eroare conexiune.</div>';
      return;
    }

    if(!r.ok){
      const t = await r.text().catch(()=> "");
      statusEl.textContent = "Eroare: " + r.status + (t ? " / " + t : " / (fără mesaj)");
      box.innerHTML = '<div style="color:var(--muted)">Eroare la randare.</div>';
      return;
    }

    // Așteptăm imagine ca blob
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    setResultImg(url);
    statusEl.textContent = "Gata ✅";
  });
</script>
</body>
</html>
